#!/usr/bin/env ruby

require "fileutils"

p root_path = File.absolute_path(File.join(__dir__, "../.."))
p template_path = File.join(root_path, "template.rb")
p builds_path = File.join(root_path, "tmp/builds")
p app_name = ENV.fetch("VARIANT_NAME", "basic")
p app_path = File.join(builds_path, app_name)
p config_path = File.join(root_path, ENV.fetch("CONFIG_PATH", "ci/configs/basic_only.yml"))
p extra_skip_flags = ENV.fetch("SKIPS", "")

puts "Installing latest rails gem"
system "gem install rails --no-document"

if !Dir.exist?(builds_path)
  puts "Creating #{builds_path}"
  FileUtils.mkdir_p(builds_path)
end

if Dir.exist?(app_path)
  puts "Removing old build from #{app_path}"
  FileUtils.rm_rf(app_path)
end

Dir.chdir(builds_path) do |cwd|
  puts "Working dir is now #{cwd}"
  p cmd = %Q{ACKAMA_RT_CONFIG_PATH="#{config_path}" RACK_ENV=development RAILS_ENV=development rails new "#{app_name}" -d postgresql --skip-javascript #{extra_skip_flags} -m "#{template_path}"}

  system cmd
end

puts "Running test suite"
Dir.chdir(app_path) do |cwd|
  puts "Working dir is now #{cwd}"
  system "./bin/ci-run"
end