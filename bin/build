#!/usr/bin/env ruby

require "fileutils"
require "yaml"
require_relative "./lib/config"
require_relative "./lib/builder"

# Usage:
#
#   $ ./build "all_variants" | "vanilla" | "default" | <ci_config_name>
#
# where <ci_config_name> is the name of a file in the `ci/configs` directory
# (minus the .yml extension)
#
# Examples:
#
#   $ ./build all_variants  # build every known variant
#   $ ./build vanilla       # build a vanilla Rails app (which doesn't use our template)
#   $ ./build default       # build using the default config
#   $ ./build basic         # build using the basic CI config
#   $ ./build react         # build using the React CI config

class Main
  class << self
    def main
      configs = Config.resolve_to_configs(ARGV.first)

      puts configs_summary(configs)

      configs.each do |config|
        Builder.new(config:).build
      end
    end

    private

    def configs_summary(configs)
      <<~EO_HEAD
        Building apps for #{configs.length} configs:
          - #{configs.map(&:name).join("\n  - ")}

      EO_HEAD
    end
  end
end

Main.main
